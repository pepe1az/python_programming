<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>User {{ user.id }}</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <nav>
    {% for item in navigation %}
      <a href="{{ item.href }}">{{ item.caption }}</a>
    {% endfor %}
  </nav>

  <h1>Пользователь: {{ user.name }} (id={{ user.id }})</h1>

  <h2>Подписки</h2>
  {% if subscriptions %}
    <ul>
      {% for c in subscriptions %}
        <li>
          <b>{{ c.char_code }}</b> — {{ c.name }}: {{ c.value }}
          <form method="post" action="/unsubscribe?user_id={{ user.id }}&currency_id={{ c.id }}" style="display:inline;">
            <button type="submit">Отписаться</button>
          </form>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Подписок нет</p>
  {% endif %}

  <h2>Подписаться на валюту</h2>
  <ul>
    {% for c in all_currencies %}
      <li>
        {{ c.char_code }} — {{ c.name }}
        <form method="post" action="/subscribe?user_id={{ user.id }}&currency_id={{ c.id }}" style="display:inline;">
          <button type="submit">Подписаться</button>
        </form>
      </li>
    {% endfor %}
  </ul>

  <h2>Динамика курса (последние ~3 месяца)</h2>
  <canvas id="chart" width="900" height="320"></canvas>

  <script>
    const chartData = {{ chart_data_json | safe }};
    const codes = Object.keys(chartData);

    const datasets = codes.map(code => ({
      label: code,
      data: chartData[code].map(p => ({x: p.t, y: p.v})),
      tension: 0.2
    }));

    const ctx = document.getElementById('chart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: { datasets },
      options: {
        parsing: false,
        scales: {
          x: { type: 'category' },
          y: { beginAtZero: false }
        }
      }
    });
  </script>
</body>
</html>
